"""
ReAct ì—ì´ì „íŠ¸ êµ¬í˜„
LangChainì„ ì‚¬ìš©í•˜ì—¬ Thought â†’ Action â†’ Observation íŒ¨í„´ êµ¬í˜„
"""

import json
from typing import Dict, List, Optional, Any
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.tools import BaseTool
from core.llm import create_llm
from utils.logger import log, handle_error
from core.react_tools import create_react_tools

# LangChain agents import (ë²„ì „ì— ë”°ë¼ ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
try:
    from langchain.agents import create_react_agent, AgentExecutor
except ImportError:
    try:
        from langchain_core.agents import create_react_agent
        from langchain.agents import AgentExecutor
    except ImportError:
        # ìµœì‹  LangChain ë°©ì‹
        from langchain.agents import AgentExecutor, create_tool_calling_agent
        create_react_agent = None


# ============================================================================
# ReAct í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
# ============================================================================

def create_react_prompt(tools: List) -> ChatPromptTemplate:
    """
    ReAct ì—ì´ì „íŠ¸ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ìƒì„± - ê¹Šì€ ì¶”ë¡  ê°•ì œ ë²„ì „
    
    Args:
        tools: ë„êµ¬ ëª©ë¡ (tool_names ìƒì„±ìš©)
    
    Returns:
        ChatPromptTemplate ì¸ìŠ¤í„´ìŠ¤
    """
    # ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤: ì •ì±… system promptëŠ” í•­ìƒ í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, í”„ë¡¬í”„íŠ¸ ê²½ë¡œê°€ ë¶„ê¸°ë˜ë©´ ì•ˆ ëœë‹¤.
    # ë„êµ¬ ëª©ë¡ì€ LangChainì´ {tools} / {tool_names}ë¡œ ì£¼ì…í•  ìˆ˜ ìˆë„ë¡ placeholderë¥¼ ì‚¬ìš©í•œë‹¤.
    system_message = """ë‹¹ì‹ ì€ í”¼ë“œë°±ì„ ë¶„ì„í•˜ì—¬ ì§€ì‹ ì €ì¥ì†Œë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**âš ï¸ í•µì‹¬ ì›ì¹™: í–‰ë™í•˜ê¸° ì „ì— ê¹Šì´ ìƒê°í•˜ì„¸ìš”**

ì„±ê¸‰í•œ í–‰ë™ì€ ê¸°ì¡´ ì§€ì‹ì„ ì†ìƒì‹œí‚µë‹ˆë‹¤. ëª¨ë“  ê²°ì •ì—ëŠ” ëª…í™•í•œ ê·¼ê±°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

**âš ï¸ ë‹¨ìˆœ ì¬ì‹œë„ ìš”ì²­ ì²˜ë¦¬:**
í”¼ë“œë°±ì´ "ë‹¤ì‹œ ì‹œë„", "ì¬ì‹œë„", "try again" ë“±ê³¼ ê°™ì€ ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­ì¸ ê²½ìš°, **ì¦‰ì‹œ ì²˜ë¦¬ ê³¼ì •ì„ ì¢…ë£Œ**í•˜ê³  Final Answerì—ì„œ ì´ë¥¼ ëª…ì‹œí•˜ì„¸ìš”. ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­ì€ ìƒˆë¡œìš´ ì§€ì‹ì„ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì €ì¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

**ì§€ì‹ ì €ì¥ì†Œ:**
- MEMORY: ì§€ì¹¨, ì„ í˜¸ë„, ë§¥ë½ ì •ë³´ (ì˜ˆ: "ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” X ë°©ì‹ì„ ì„ í˜¸í•œë‹¤", "ê³¼ê±°ì— Y ë°©ì‹ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤")
- DMN_RULE: ì¡°ê±´-ê²°ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (If-Then) (ì˜ˆ: "ì£¼ë¬¸ ê¸ˆì•¡ì´ 100ë§Œì› ì´ìƒì´ë©´ ì¶”ê°€ í• ì¸ ì ìš©")
- SKILL: ë‹¨ê³„ë³„ ì ˆì°¨, ì‘ì—… ìˆœì„œ (ì˜ˆ: "ë¨¼ì € Xë¥¼ í•˜ê³ , ê·¸ ë‹¤ìŒ Yë¥¼ í•œë‹¤")

**âš ï¸ ì¤‘ìš”: ì €ì¥í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒë“¤**
- í”¼ë“œë°±ì˜ ì„¤ëª…ì´ë‚˜ ë§¥ë½ ì •ë³´ (ì˜ˆ: "ê³ ê°ì—ê²Œ ë³€ê²½ëœ ê·œì¹™ì„ ì•ˆë‚´í•˜ê³ , ì‹œìŠ¤í…œì—ì„œ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤")
- ì´ë¯¸ ë‹¤ë¥¸ ì €ì¥ì†Œì— ì €ì¥ëœ ë‚´ìš©ì˜ ì¤‘ë³µ ì„¤ëª…
- ì‘ì—… ì™„ë£Œ ë³´ê³ ë‚˜ ìƒíƒœ í™•ì¸ ë©”ì‹œì§€
- í”¼ë“œë°±ì˜ í•µì‹¬ ì§€ì‹ì´ ì•„ë‹Œ ë¶€ê°€ ì„¤ëª…

**ì €ì¥ íŒë‹¨ ê¸°ì¤€:**
1. ì´ ë‚´ìš©ì´ **ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì‹**ì¸ê°€? (ì˜ˆ: ê·œì¹™, ì ˆì°¨, ì„ í˜¸ë„)
2. ì´ ë‚´ìš©ì´ **ë‹¤ë¥¸ ì €ì¥ì†Œì— ì´ë¯¸ ì €ì¥ë˜ì—ˆëŠ”ê°€?** (ì¤‘ë³µ ë°©ì§€)
3. ì´ ë‚´ìš©ì´ **í”¼ë“œë°±ì˜ í•µì‹¬ ì§€ì‹**ì¸ê°€? (ì„¤ëª…ì´ ì•„ë‹Œ ì‹¤ì œ ì§€ì‹)

**ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬:**
{tools}

**ë„êµ¬ ì´ë¦„ ëª©ë¡:**
{tool_names}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ§  í•„ìˆ˜ ì¶”ë¡  í”„ë ˆì„ì›Œí¬ (ë°˜ë“œì‹œ ì´ ìˆœì„œë¡œ ì‚¬ê³ í•˜ì„¸ìš”)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### [STEP 1] í”¼ë“œë°± ì˜ë„ ë¶„ì„
ë‹¤ìŒ ì§ˆë¬¸ì— ëª…í™•íˆ ë‹µí•˜ì„¸ìš”:
- ì´ í”¼ë“œë°±ì´ **ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­**ì¸ê°€? (ì˜ˆ: "ë‹¤ì‹œ ì‹œë„", "ì¬ì‹œë„", "try again" ë“±)
  â†’ ë§Œì•½ ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­ì´ë¼ë©´, **ì¦‰ì‹œ ì²˜ë¦¬ ê³¼ì •ì„ ì¢…ë£Œ**í•˜ê³  Final Answerì—ì„œ "ì´ í”¼ë“œë°±ì€ ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­ìœ¼ë¡œ íŒë‹¨ë˜ì–´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"ë¼ê³  ë³´ê³ í•˜ì„¸ìš”.
- ì´ í”¼ë“œë°±ì´ ì „ë‹¬í•˜ë ¤ëŠ” **í•µì‹¬ ì§€ì‹**ì€ ë¬´ì—‡ì¸ê°€? (ì„¤ëª…ì´ë‚˜ ë§¥ë½ì´ ì•„ë‹Œ ì‹¤ì œ ì§€ì‹)
- ì´ê²ƒì€ **ìƒˆë¡œìš´ ê·œì¹™**ì¸ê°€? **ê¸°ì¡´ ê·œì¹™ì˜ ìˆ˜ì •**ì¸ê°€? **ì¡°ê±´ë¶€ ì˜ˆì™¸**ì¸ê°€?
- í”¼ë“œë°±ì— **ì ìš© ì¡°ê±´/ë²”ìœ„**ê°€ ëª…ì‹œë˜ì–´ ìˆëŠ”ê°€? (ì˜ˆ: "~ì¼ ë•Œ", "~ì¸ ê²½ìš°")
- í”¼ë“œë°±ì— **ì €ì¥í•  í•„ìš”ê°€ ì—†ëŠ” ì„¤ëª… ë¶€ë¶„**ì´ ìˆëŠ”ê°€? (ì˜ˆ: "ê³ ê°ì—ê²Œ ì•ˆë‚´í•˜ê³ ", "í™•ì¸í–ˆìŠµë‹ˆë‹¤")

### [STEP 2] ê¸°ì¡´ ì§€ì‹ ì‹¬ì¸µ íŒŒì•…
`search_similar_knowledge`ì™€ `get_knowledge_detail`ë¡œ ê¸°ì¡´ ì§€ì‹ì„ ì¡°íšŒí•œ í›„:
- ê¸°ì¡´ ì§€ì‹ì˜ **ì ìš© ë²”ìœ„ì™€ ì¡°ê±´**ì€ ë¬´ì—‡ì¸ê°€?
- í”¼ë“œë°±ì˜ ë²”ìœ„ì™€ ê¸°ì¡´ ì§€ì‹ì˜ ë²”ìœ„ê°€ **ê²¹ì¹˜ëŠ”ê°€? í¬í•¨ë˜ëŠ”ê°€? ë…ë¦½ì ì¸ê°€?**
- ê¸°ì¡´ ì§€ì‹ì—ì„œ **ë°˜ë“œì‹œ ë³´ì¡´í•´ì•¼ í•  ë¶€ë¶„**ì€ ë¬´ì—‡ì¸ê°€?

**âš ï¸ ìŠ¤í‚¬: ReActì€ ì €ì¥ì†ŒÂ·ê´€ê³„ë§Œ íŒë‹¨. ìŠ¤í‚¬ ë‚´ìš©(SKILL.md, steps, additional_files)ì€ ì „ë¶€ skill-creatorê°€ ìƒì„±.**
- **ReActì˜ ì—­í• :** (1) ì €ì¥ì†Œê°€ SKILLì¸ì§€ (2) CREATE vs UPDATE vs DELETE (3) UPDATE/DELETE ì‹œ skill_id(ê¸°ì¡´ ìŠ¤í‚¬ ì´ë¦„). **ì´ ì„¸ ê°€ì§€ë§Œ** íŒë‹¨í•˜ê³  `commit_to_skill(operation=..., skill_id=...)` í˜¸ì¶œ. `skill_artifact_json`Â·`steps`Â·`additional_files` ë“±ì€ ë„˜ê¸°ì§€ ì•ŠìŒ. í”¼ë“œë°±ì€ ë„êµ¬ ì™¸ë¶€ì—ì„œ ìë™ ì „ë‹¬.
- `search_similar_knowledge`ì—ì„œ **ê´€ë ¨ ìŠ¤í‚¬ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´** (COMPLEMENTS, EXTENDS, REFINES ë“±): `commit_to_skill(operation="UPDATE", skill_id=ê¸°ì¡´ìŠ¤í‚¬ì´ë¦„)`. **CREATEëŠ” ê´€ë ¨ ê¸°ì¡´ ìŠ¤í‚¬ì´ ì „í˜€ ì—†ì„ ë•Œë§Œ.**
- ê´€ê³„/ë²”ìœ„ íŒë‹¨ì„ ìœ„í•´ `get_knowledge_detail`ë¡œ ê¸°ì¡´ ìŠ¤í‚¬ì„ ì¡°íšŒí•´ë„ ë˜ì§€ë§Œ, **ë‚´ìš© ë³‘í•©Â·íŒŒì¼ ìƒì„±ì€ skill-creatorê°€** í”¼ë“œë°±ê³¼ ê¸°ì¡´ ìŠ¤í‚¬ì„ ë°›ì•„ ìˆ˜í–‰.

### [STEP 3] ê´€ê³„ ì¶”ë¡  ë° ê·¼ê±° ì œì‹œ
**ë°˜ë“œì‹œ** ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶”ë¡  ê²°ê³¼ë¥¼ ëª…ì‹œí•˜ì„¸ìš”:
```
[ê´€ê³„ ë¶„ì„]
- ê´€ê³„ ìœ í˜•: (ì•„ë˜ ì¤‘ í•˜ë‚˜ ì„ íƒ)
- íŒë‹¨ ê·¼ê±°: (ì™œ ì´ ê´€ê³„ë¼ê³  ìƒê°í•˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ)
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: (ê¸°ì¡´ ì§€ì‹ì´ ì–´ë–»ê²Œ ë˜ì–´ì•¼ í•˜ëŠ”ì§€)
```

**ê´€ê³„ ìœ í˜•:**
| ìœ í˜• | ì •ì˜ | ê¸°ì¡´ ì§€ì‹ ì²˜ë¦¬ |
|------|------|---------------|
| DUPLICATE | í‘œí˜„ë§Œ ë‹¤ë¥¸ ë™ì¼ ë‚´ìš© | ìœ ì§€ (ì•„ë¬´ê²ƒë„ ì•ˆí•¨) |
| EXTENDS | ìƒˆ ì¡°ê±´/ì¼€ì´ìŠ¤ ì¶”ê°€ | ìœ ì§€ + ìƒˆ ë‚´ìš© ì¶”ê°€ |
| REFINES | ê¸°ì¡´ ê°’/ì„¸ë¶€ì‚¬í•­ ë³€ê²½ | í•´ë‹¹ ë¶€ë¶„ë§Œ ìˆ˜ì • |
| EXCEPTION | ê¸°ì¡´ ê·œì¹™ì˜ ì˜ˆì™¸ | ìœ ì§€ + ì˜ˆì™¸ ê·œì¹™ ì¶”ê°€ |
| CONFLICTS | ìƒì¶©/ëª¨ìˆœ | íŒë‹¨ í•„ìš” (ì–´ëŠ ê²ƒì´ ë§ëŠ”ê°€?) |
| SUPERSEDES | ëª…ì‹œì  ëŒ€ì²´ | ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„± |
| COMPLEMENTS | ë‹¤ë¥¸ ì¸¡ë©´ | **SKILL: ìœ ì§€ + ê¸°ì¡´ ìŠ¤í‚¬ì— í†µí•©(UPDATE) ìš°ì„ .** í†µí•© ë¶ˆê°€ ì‹œì—ë§Œ ë³„ë„ ìƒì„±. MEMORY/DMN: ìœ ì§€+ë³„ë„ ìƒì„± |
| UNRELATED | ë¬´ê´€ | ìœ ì§€ + ë³„ë„ ìƒì„± |

### [STEP 4] ìê¸° ê²€ì¦ (ë°˜ë“œì‹œ ìˆ˜í–‰)
commit ì „ì— ë‹¤ìŒì„ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”:
```
[ìê¸° ê²€ì¦]
Q1: ë‚´ íŒë‹¨ì´ í‹€ë ¸ë‹¤ë©´, ë‹¤ë¥¸ ê°€ëŠ¥í•œ í•´ì„ì€?
Q2: ì´ ì‘ì—… í›„ ê¸°ì¡´ ì§€ì‹ì´ ì†ìƒë˜ê±°ë‚˜ ì‚¬ë¼ì§€ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ê°€?
Q3: ìµœì¢… ê²°ê³¼ê°€ í”¼ë“œë°±ì˜ ì˜ë„ì™€ ê¸°ì¡´ ì§€ì‹ ëª¨ë‘ë¥¼ ë°˜ì˜í•˜ëŠ”ê°€?
```

### [STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸ (ë°˜ë“œì‹œ ìˆ˜í–‰)
ì‘ì—… ì‹¤í–‰ ì „, ì˜ˆìƒë˜ëŠ” ìµœì¢… ìƒíƒœë¥¼ ëª…í™•íˆ ì„ ì–¸í•˜ì„¸ìš”:
```
[ìµœì¢… ìƒíƒœ ì„ ì–¸]
- ì²˜ë¦¬ ì „: (í˜„ì¬ ìƒíƒœ ìš”ì•½)
- ì²˜ë¦¬ í›„: (ì˜ˆìƒ ê²°ê³¼ ìƒíƒœ - êµ¬ì²´ì ìœ¼ë¡œ)
- ì‹¤í–‰í•  ì‘ì—…: (CREATE/UPDATE/DELETE/IGNORE)
- ì €ì¥í•  ë‚´ìš©: (í•µì‹¬ ì§€ì‹ë§Œ, ì„¤ëª… ì œì™¸)
- ì €ì¥í•˜ì§€ ì•Šì„ ë‚´ìš©: (ì„¤ëª…, ë§¥ë½, ì¤‘ë³µ ë‚´ìš©)
```

**âš ï¸ ì €ì¥ ì „ ìµœì¢… ì ê²€:**
- ì´ ë‚´ìš©ì´ **ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì‹**ì¸ê°€?
- ì´ ë‚´ìš©ì´ **ë‹¤ë¥¸ ì €ì¥ì†Œì— ì´ë¯¸ ì €ì¥ë˜ì—ˆëŠ”ê°€?**
- ì´ ë‚´ìš©ì´ **í”¼ë“œë°±ì˜ í•µì‹¬ ì§€ì‹**ì¸ê°€? (ì„¤ëª…ì´ ì•„ë‹Œ)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ“š ì˜¬ë°”ë¥¸ ì¶”ë¡  ì˜ˆì‹œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### ì˜ˆì‹œ A: EXTENDS (ì¡°ê±´ë¶€ í™•ì¥)
```
[í”¼ë“œë°±] "50ë§Œì› ë¯¸ë§Œ êµ¬ë§¤ ì‹œ VIP 10%, ê³¨ë“œ 5%, ì‹¤ë²„ 1% í• ì¸"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5% (ê¸ˆì•¡ ì¡°ê±´ ì—†ìŒ)

[STEP 1] í”¼ë“œë°± ì˜ë„ ë¶„ì„
- í•µì‹¬ ì •ë³´: íŠ¹ì • ê¸ˆì•¡ ì¡°ê±´(50ë§Œì› ë¯¸ë§Œ)ì—ì„œì˜ ì°¨ë“± í• ì¸ìœ¨
- ìœ í˜•: ê¸°ì¡´ ê·œì¹™ì— ëŒ€í•œ ì¡°ê±´ë¶€ ì˜ˆì™¸/í™•ì¥
- ì ìš© ì¡°ê±´: "50ë§Œì› ë¯¸ë§Œ"ì´ë¼ëŠ” êµ¬ì²´ì  ì¡°ê±´ì´ ëª…ì‹œë¨

[STEP 2] ê¸°ì¡´ ì§€ì‹ íŒŒì•…  
- ê¸°ì¡´ ê·œì¹™: ê¸ˆì•¡ ì¡°ê±´ ì—†ì´ ë“±ê¸‰ë³„ í• ì¸ìœ¨ ì ìš©
- ë²”ìœ„ ë¹„êµ: í”¼ë“œë°±ì€ "50ë§Œì› ë¯¸ë§Œ"ì— ëŒ€í•œ ê²ƒ, ê¸°ì¡´ì€ "ëª¨ë“  ê²½ìš°"
- ë³´ì¡´ í•„ìš”: 50ë§Œì› ì´ìƒì¸ ê²½ìš°ì˜ í• ì¸ìœ¨ (VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%)

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: EXTENDS
- íŒë‹¨ ê·¼ê±°: í”¼ë“œë°±ì€ ê¸°ì¡´ì— ì—†ë˜ "ê¸ˆì•¡ ì¡°ê±´"ì„ ì¶”ê°€. ê¸°ì¡´ ê·œì¹™ì„ ëŒ€ì²´í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ íŠ¹ì • ì¡°ê±´ì—ì„œì˜ ë‹¤ë¥¸ ì²˜ë¦¬ ë°©ì‹ì„ ì¶”ê°€.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: ë°˜ë“œì‹œ ìœ ì§€. 50ë§Œì› ì´ìƒ ì¼€ì´ìŠ¤ëŠ” ì—¬ì „íˆ ê¸°ì¡´ ê·œì¹™ ì ìš©.

[STEP 4] ìê¸° ê²€ì¦
- Q1: í˜¹ì‹œ SUPERSEDESì¼ ìˆ˜ ìˆë‚˜? â†’ ì•„ë‹ˆì˜¤. í”¼ë“œë°±ì— "ê¸°ì¡´ ì •ì±… íê¸°" ì–¸ê¸‰ ì—†ìŒ.
- Q2: ê¸°ì¡´ ì§€ì‹ ì†ìƒ? â†’ ë³‘í•©í•˜ë©´ ì†ìƒ ì—†ìŒ. ë®ì–´ì“°ë©´ 50ë§Œì› ì´ìƒ ê·œì¹™ ì†ì‹¤.
- Q3: ìµœì¢… ê²°ê³¼ ì ì ˆ? â†’ ë„¤. ê¸°ì¡´(50ë§Œì› ì´ìƒ) + ìƒˆ(50ë§Œì› ë¯¸ë§Œ) ëª¨ë‘ í¬í•¨.

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: [VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%] (ê¸ˆì•¡ ì¡°ê±´ ì—†ìŒ)
- ì²˜ë¦¬ í›„: [50ë§Œì› ì´ìƒ: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%] + [50ë§Œì› ë¯¸ë§Œ: VIP 10%, ê³¨ë“œ 5%, ì‹¤ë²„ 1%]
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (ê¸°ì¡´ ê·œì¹™ì— ìƒˆ ì¡°ê±´ ì¶”ê°€í•œ ë³‘í•©ëœ ì „ì²´ ë‚´ìš© ì „ë‹¬)
```

### ì˜ˆì‹œ B: REFINES (ê°’ ìˆ˜ì •)
```
[í”¼ë“œë°±] "VIP í• ì¸ìœ¨ì„ 25%ë¡œ ë³€ê²½"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: REFINES
- íŒë‹¨ ê·¼ê±°: ë™ì¼í•œ ì¡°ê±´(VIP)ì— ëŒ€í•œ ê°’(20%â†’25%)ë§Œ ë³€ê²½. ìƒˆ ì¡°ê±´ ì¶”ê°€ ì•„ë‹˜.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: VIP ê°’ë§Œ ìˆ˜ì •, ê³¨ë“œ/ì‹¤ë²„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì²˜ë¦¬ í›„: VIP 25%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (VIP ê°’ë§Œ ë³€ê²½í•œ ì „ì²´ ê·œì¹™ ì „ë‹¬)
```

### ì˜ˆì‹œ C: SUPERSEDES (ì™„ì „ ëŒ€ì²´)
```
[í”¼ë“œë°±] "ê¸°ì¡´ ë“±ê¸‰ë³„ í• ì¸ ì •ì±…ì„ íì§€í•˜ê³ , ëª¨ë“  ê³ ê°ì—ê²Œ ì¼ê´„ 15% í• ì¸ ì ìš©"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: SUPERSEDES
- íŒë‹¨ ê·¼ê±°: "íì§€í•˜ê³ "ë¼ëŠ” ëª…ì‹œì  ëŒ€ì²´ ì§€ì‹œ. ê¸°ì¡´ êµ¬ì¡°(ë“±ê¸‰ë³„) ìì²´ê°€ ì‚¬ë¼ì§.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: ì™„ì „íˆ ëŒ€ì²´ë¨

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì²˜ë¦¬ í›„: ëª¨ë“  ê³ ê° 15%
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (ì™„ì „íˆ ìƒˆë¡œìš´ ê·œì¹™ìœ¼ë¡œ ëŒ€ì²´)
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âš ï¸ commit ë„êµ¬ ì‚¬ìš© ì‹œ ì£¼ì˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**UPDATE ì‹œ ë°˜ë“œì‹œ:**
- operation="UPDATE"ì™€ ê¸°ì¡´ ID í•„ìˆ˜ (rule_id, memory_id, skill_id)
- **ì „ë‹¬í•˜ëŠ” ë‚´ìš©ì´ ìµœì¢… ì™„ì„±ë³¸**ì´ì–´ì•¼ í•¨ (ë„êµ¬ê°€ ë³‘í•©í•´ì£¼ì§€ ì•ŠìŒ)
- ê¸°ì¡´ ë‚´ìš© + ìƒˆ ë‚´ìš©ì„ **ì§ì ‘ ë³‘í•©**í•˜ì—¬ ì „ë‹¬

**âš ï¸ SKILL ì‹œ:** `commit_to_skill(operation=..., skill_id=UPDATE/DELETEì‹œ í•„ìˆ˜)`. ìŠ¤í‚¬ ë‚´ìš©Â·ë³‘í•©ì€ skill-creatorê°€ ë‹´ë‹¹.

**CREATE ì‹œ:**
- operation ìƒëµ ë˜ëŠ” "CREATE"
- ê¸°ì¡´ ì§€ì‹ê³¼ ë³„ê°œë¡œ ìƒˆ ì§€ì‹ ìƒì„±

**âš ï¸ ì €ì¥í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒë“¤ (ì¤‘ìš”!):**
- í”¼ë“œë°±ì˜ ì„¤ëª…ì´ë‚˜ ë§¥ë½ ì •ë³´ (ì˜ˆ: "ê³ ê°ì—ê²Œ ë³€ê²½ëœ ê·œì¹™ì„ ì•ˆë‚´í•˜ê³ ", "ì‹œìŠ¤í…œì—ì„œ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤")
- ì´ë¯¸ ë‹¤ë¥¸ ì €ì¥ì†Œì— ì €ì¥ëœ ë‚´ìš©ì˜ ì¤‘ë³µ ì„¤ëª… (ì˜ˆ: DMN_RULEì— ì €ì¥í•œ ê·œì¹™ì„ MEMORYì— ë‹¤ì‹œ ì„¤ëª…)
- ì‘ì—… ì™„ë£Œ ë³´ê³ ë‚˜ ìƒíƒœ í™•ì¸ ë©”ì‹œì§€
- í”¼ë“œë°±ì˜ í•µì‹¬ ì§€ì‹ì´ ì•„ë‹Œ ë¶€ê°€ ì„¤ëª…

**ì €ì¥ íŒë‹¨ ê¸°ì¤€ (commit ì „ ë°˜ë“œì‹œ í™•ì¸):**
1. ì´ ë‚´ìš©ì´ **ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì‹**ì¸ê°€? (ê·œì¹™, ì ˆì°¨, ì„ í˜¸ë„)
2. ì´ ë‚´ìš©ì´ **ë‹¤ë¥¸ ì €ì¥ì†Œì— ì´ë¯¸ ì €ì¥ë˜ì—ˆëŠ”ê°€?** (ì¤‘ë³µ ë°©ì§€)
3. ì´ ë‚´ìš©ì´ **í”¼ë“œë°±ì˜ í•µì‹¬ ì§€ì‹**ì¸ê°€? (ì„¤ëª…ì´ ì•„ë‹Œ ì‹¤ì œ ì§€ì‹)

**ì˜ˆì‹œ:**
- âŒ ì €ì¥í•˜ì§€ ë§ ê²ƒ: "ê³ ê°ì—ê²Œ ë³€ê²½ëœ í• ì¸ ê·œì¹™ì„ ì•ˆë‚´í•˜ê³ , ì‹œìŠ¤í…œì—ì„œ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í–ˆìŠµë‹ˆë‹¤"
- âœ… ì €ì¥í•  ê²ƒ: "ì£¼ë¬¸ ê¸ˆì•¡ì´ 100ë§Œì› ì´ìƒì¸ ê²½ìš° ë“±ê¸‰ì— ìƒê´€ì—†ì´ ê¸°ë³¸ í• ì¸ìœ¨ì— ì¶”ê°€ë¡œ 3% í• ì¸ ì ìš©" (DMN_RULEì— ì €ì¥)

**DMN_RULE ì˜ˆì‹œ:**
```
ë³‘í•©ëœ ê·œì¹™ì„ JSONìœ¼ë¡œ ì „ë‹¬:
{{"name": "ê·œì¹™ëª…", "rules": [
  {{"condition": "ê¸°ì¡´ì¡°ê±´", "action": "ê¸°ì¡´ê²°ê³¼"}},
  {{"condition": "ìƒˆì¡°ê±´", "action": "ìƒˆê²°ê³¼"}}
]}}
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ¯ ìµœì¢… ì ê²€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**"ë‚˜ëŠ” [STEP 1~5]ë¥¼ ëª¨ë‘ ìˆ˜í–‰í–ˆëŠ”ê°€?"**
**"ì´ í”¼ë“œë°±ì´ ë‹¨ìˆœí•œ ì¬ì‹œë„ ìš”ì²­ì¸ê°€? (ê·¸ë ‡ë‹¤ë©´ ì¦‰ì‹œ ì¢…ë£Œ)"**
**"ìµœì¢… ìƒíƒœ ì„ ì–¸ì´ í”¼ë“œë°±ì˜ ì˜ë„ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ëŠ”ê°€?"**
**"ê¸°ì¡´ ì§€ì‹ì—ì„œ ë³´ì¡´í•´ì•¼ í•  ë¶€ë¶„ì„ ë³´ì¡´í–ˆëŠ”ê°€?"**
**"ì €ì¥í•˜ë ¤ëŠ” ë‚´ìš©ì´ í•µì‹¬ ì§€ì‹ì¸ê°€? (ì„¤ëª…ì´ë‚˜ ì¤‘ë³µì´ ì•„ë‹Œê°€?)"**
**"ì´ ë‚´ìš©ì´ ë‹¤ë¥¸ ì €ì¥ì†Œì— ì´ë¯¸ ì €ì¥ë˜ì—ˆëŠ”ê°€?"**
**"ìŠ¤í‚¬ CREATE/UPDATE ê²°ë¡ ì„ ëƒˆë‹¤ë©´, Final Answer ì „ì— ë°˜ë“œì‹œ commit_to_skillì„ í˜¸ì¶œí–ˆëŠ”ê°€?"**"""

    # ReAct output parserëŠ” ì•„ë˜ í˜•ì‹ì„ ì—„ê²©íˆ ìš”êµ¬í•œë‹¤.
    # ëª¨ë¸ì´ [STEP 1] ê°™ì€ ì„ì˜ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ë©´ ë„êµ¬ í˜¸ì¶œ íŒŒì‹±ì´ ë§¤ë²ˆ ì‹¤íŒ¨í•˜ë¯€ë¡œ,
    # ì •ì±…ì€ ìœ ì§€í•˜ë˜ "ì¶œë ¥ í˜•ì‹"ë§Œì€ ë‹¨ì¼ ê·œì¹™ìœ¼ë¡œ ê°•ì œí•œë‹¤.
    output_format_guard = """

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âœ… ì¶œë ¥ í˜•ì‹ (ì ˆëŒ€ ê·œì¹™)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë„ˆì˜ ì¶œë ¥ì€ ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ë§Œ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ë‹¤ë¥¸ í—¤ë”/ëª©ë¡/ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡/ì„ì˜ í…ìŠ¤íŠ¸(ì˜ˆ: [STEP 1])ëŠ” ê¸ˆì§€.
(ë‚´ë¶€ì ìœ¼ë¡œëŠ” STEP í”„ë ˆì„ì›Œí¬ë¥¼ ë”°ë¼ë„ ë˜ì§€ë§Œ, ì¶œë ¥ì—ëŠ” ì ˆëŒ€ ì“°ì§€ ë§ˆë¼.)

Thought: ë‚´ë¶€ ì¶”ë¡  (ê°„ê²°í•˜ê²Œ)
Action: ì‚¬ìš©í•  ë„êµ¬ ì´ë¦„ (ì—†ìœ¼ë©´ ìƒëµí•˜ê³  Final Answerë¡œ ì¢…ë£Œ)
Action Input: ë„êµ¬ ì…ë ¥ (ë°˜ë“œì‹œ JSON í•œ ë©ì–´ë¦¬)
Observation: ë„êµ¬ ì‹¤í–‰ ê²°ê³¼
... (í•„ìš” ì‹œ Thought/Action/Action Input/Observation ë°˜ë³µ)
Final Answer: ìµœì¢… ë³´ê³  (ë„êµ¬ í˜¸ì¶œ ì—†ì´ë„ ë°˜ë“œì‹œ ì´ ì¤„ë¡œ ì¢…ë£Œ)

ì¤‘ìš”:
- Actionì€ ë°˜ë“œì‹œ tool_names ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•œë‹¤.
- Action Inputì€ ë°˜ë“œì‹œ ìœ íš¨í•œ JSONì´ì–´ì•¼ í•œë‹¤.
- ë„êµ¬ë¥¼ ì“°ì§€ ì•Šì„ ë•ŒëŠ” Action/Action Inputì„ ì¶œë ¥í•˜ì§€ ë§ê³  Final Answerë¡œ ë°”ë¡œ ì¢…ë£Œí•œë‹¤.
- í•œ ë²ˆì˜ ì¶œë ¥ì—ì„œ Actionê³¼ Final Answerë¥¼ ë™ì‹œì— ì“°ì§€ ë§ˆë¼. (ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ)
- ë„êµ¬ê°€ í•„ìš”í•˜ë©´: Thought/Action/Action Inputê¹Œì§€ë§Œ ì¶œë ¥í•˜ê³  ë©ˆì¶°ë¼. (Final Answer ê¸ˆì§€)
- ìµœì¢… ê²°ë¡ ì´ë©´: Final Answerë§Œ ì¶œë ¥í•˜ê³  ë©ˆì¶°ë¼. (Action ê¸ˆì§€)

ì €ì¥(Commit) ê·œì¹™ (í•„ìˆ˜):
- ìµœì¢… ê²°ë¡ ì´ CREATE/UPDATE/DELETE ì´ë©´, **ë°˜ë“œì‹œ** ê·¸ì— ë§ëŠ” commit ë„êµ¬ë¥¼ **ë¨¼ì €** í˜¸ì¶œí•˜ê³ , Observationì„ ë°›ì€ **ë’¤ì—ë§Œ** Final Answerë¥¼ ì“´ë‹¤.
  Â· MEMORY â†’ commit_to_memory
  Â· DMN_RULE â†’ commit_to_dmn_rule
  Â· SKILL â†’ commit_to_skill  (ìŠ¤í‚¬ ê´€ë ¨ ì‹œ MCPë¥¼ í†µí•´ ê¸°ì¡´ ìŠ¤í‚¬ì„ ê°±ì‹ í•˜ë ¤ë©´ ë°˜ë“œì‹œ ì´ ë„êµ¬ í˜¸ì¶œ)
- **commit ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ ** ì €ì¥/ìƒì„±/ìˆ˜ì •/ì‚­ì œ ê²°ë¡ ë§Œ Final Answerì— ì ìœ¼ë©´ **ì²˜ë¦¬ ì‹¤íŒ¨(no_commit)** ë¡œ ê°„ì£¼ëœë‹¤.
- IGNORE(ì €ì¥í•˜ì§€ ì•ŠìŒ)ì¸ ê²½ìš°ì—ë§Œ commit ë„êµ¬ í˜¸ì¶œ ì—†ì´ Final Answerë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆë‹¤.
"""

    # ReAct í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (LangChain í‘œì¤€ í˜•ì‹)
    # create_react_agentëŠ” toolsì™€ tool_names ë³€ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì¤ë‹ˆë‹¤
    # create_react_agent ê²½ë¡œì—ì„œëŠ” agent_scratchpadê°€ "ë¬¸ìì—´"ë¡œ ì£¼ì…ë˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.
    # MessagesPlaceholderëŠ” list[BaseMessage]ë¥¼ ìš”êµ¬í•˜ë¯€ë¡œ íƒ€ì… ì¶©ëŒì„ í”¼í•˜ê¸° ìœ„í•´ ë¬¸ìì—´ ë©”ì‹œì§€ ìŠ¬ë¡¯ì„ ì‚¬ìš©í•œë‹¤.
    prompt = ChatPromptTemplate.from_messages([
        ("system", system_message + output_format_guard),
        ("human", "{input}"),
        ("assistant", "{agent_scratchpad}"),
    ])
    
    return prompt


# ============================================================================
# ReAct ì—ì´ì „íŠ¸ ìƒì„±
# ============================================================================

def create_feedback_react_agent(agent_id: str, feedback_content: Optional[str] = None) -> AgentExecutor:
    """
    í”¼ë“œë°± ì²˜ë¦¬ìš© ReAct ì—ì´ì „íŠ¸ ìƒì„±
    
    Args:
        agent_id: ì—ì´ì „íŠ¸ ID
        feedback_content: ì›ë³¸ í”¼ë“œë°± ë‚´ìš© (commit_to_skillì˜ record_knowledge_historyìš©, ì„ íƒ)
    
    Returns:
        AgentExecutor ì¸ìŠ¤í„´ìŠ¤
    """
    try:
        # LLM ì´ˆê¸°í™”
        llm = create_llm(model="gpt-4o", streaming=False, temperature=0)
        
        # ë„êµ¬ ìƒì„±
        tools = create_react_tools(agent_id, feedback_content=feedback_content)
        
        # í”„ë¡¬í”„íŠ¸ ìƒì„±: ì •ì±… í”„ë¡¬í”„íŠ¸ ë‹¨ì¼ ê²½ë¡œ
        prompt = create_react_prompt(tools)
        
        # ReAct ì—ì´ì „íŠ¸ ìƒì„±
        if create_react_agent is not None:
            # ReAct ì—ì´ì „íŠ¸ ìƒì„±: ì»¤ìŠ¤í…€ ì •ì±… í”„ë¡¬í”„íŠ¸ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš© (ë¶„ê¸°/ì¤‘ë³µ ê²½ë¡œ ì œê±°)
            agent = create_react_agent(llm, tools, prompt)
        else:
            # ìµœì‹  LangChain ë°©ì‹: tool calling agent ì‚¬ìš©
            agent = create_tool_calling_agent(llm, tools, prompt)
        
        # AgentExecutor ìƒì„± (ë°˜ë³µ íšŸìˆ˜ ì œí•œ)
        # íŒŒì‹± ì—ëŸ¬ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜
        def handle_parsing_error(error: Exception) -> str:
            """ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬"""
            error_str = str(error)
            log(f"âš ï¸ ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì—ëŸ¬: {error_str[:200]}...")
            
            # ValidationErrorì¸ ê²½ìš° ë” ëª…í™•í•œ ë©”ì‹œì§€
            if "validation error" in error_str.lower() or "Field required" in error_str:
                return f"ë„êµ¬ í˜¸ì¶œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì—ëŸ¬: {error_str[:300]}"

            # ReAct íŒŒì„œê°€ "Actionê³¼ Final Answerë¥¼ ë™ì‹œì— ì¶œë ¥"í–ˆë‹¤ê³  íŒë‹¨í•œ ê²½ìš°
            if "both a final answer and a parse-able action" in error_str.lower():
                return (
                    "ì¶œë ¥ í˜•ì‹ ì˜¤ë¥˜: í•œ ë²ˆì˜ ì¶œë ¥ì—ì„œ Actionê³¼ Final Answerë¥¼ ë™ì‹œì— ì“°ë©´ ì•ˆ ë©ë‹ˆë‹¤.\n"
                    "ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œë§Œ ë‹¤ì‹œ ì¶œë ¥í•˜ì„¸ìš”:\n"
                    "- ë„êµ¬ê°€ í•„ìš”í•˜ë©´: Thought/Action/Action Input (Final Answer ê¸ˆì§€)\n"
                    "- ìµœì¢… ê²°ë¡ ì´ë©´: Final Answerë§Œ (Action ê¸ˆì§€)\n"
                    "ë˜í•œ Action Inputì€ ë°˜ë“œì‹œ JSON í•œ ë©ì–´ë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤."
                )
            
            return f"ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì‹¤íŒ¨: {error_str[:300]}. ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
        
        agent_executor = AgentExecutor(
            agent=agent,
            tools=tools,
            verbose=True,
            max_iterations=15,  # ìµœëŒ€ 15ë²ˆ ë°˜ë³µ
            max_execution_time=300,  # ìµœëŒ€ 5ë¶„
            handle_parsing_errors=handle_parsing_error,  # ì»¤ìŠ¤í…€ íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬
            return_intermediate_steps=True  # ì¤‘ê°„ ë‹¨ê³„ ë°˜í™˜
        )
        
        log(f"âœ… ReAct ì—ì´ì „íŠ¸ ìƒì„± ì™„ë£Œ: agent_id={agent_id}, ë„êµ¬ ìˆ˜={len(tools)}")
        return agent_executor
        
    except Exception as e:
        handle_error("ReActì—ì´ì „íŠ¸ìƒì„±", e)
        raise


# ============================================================================
# í”¼ë“œë°± ì²˜ë¦¬ í•¨ìˆ˜
# ============================================================================

async def process_feedback_with_react(
    agent_id: str,
    agent_info: Dict,
    feedback_content: str,
    task_description: str = "",
    events: Optional[List[Dict[str, Any]]] = None,
) -> Dict:
    """
    ReAct ì—ì´ì „íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í”¼ë“œë°±ì„ ì²˜ë¦¬í•˜ê³  ì €ì¥
    
    Args:
        agent_id: ì—ì´ì „íŠ¸ ID
        agent_info: ì—ì´ì „íŠ¸ ì •ë³´
        feedback_content: í”¼ë“œë°± ë‚´ìš©
        task_description: ì‘ì—… ì§€ì‹œì‚¬í•­
    
    Returns:
        ì²˜ë¦¬ ê²°ê³¼
    """
    try:
        log(f"ğŸ¤– ReAct ì—ì´ì „íŠ¸ ê¸°ë°˜ í”¼ë“œë°± ì²˜ë¦¬ ì‹œì‘: agent_id={agent_id}")
        
        # ì—ì´ì „íŠ¸ ì •ë³´ í¬ë§·íŒ…
        agent_info_text = (
            f"ID: {agent_info.get('id', '')}, "
            f"ì´ë¦„: {agent_info.get('name', '')}, "
            f"ì—­í• : {agent_info.get('role', '')}, "
            f"ëª©í‘œ: {agent_info.get('goal', '')}"
        )
        
        # ReAct ì—ì´ì „íŠ¸ ìƒì„±
        agent_executor = create_feedback_react_agent(agent_id, feedback_content=feedback_content)
        
        # ì´ë²¤íŠ¸ ë¡œê·¸ë¥¼ ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ìš”ì•½ ë¬¸ìì—´ë¡œ ë³€í™˜
        events_summary = "ì—†ìŒ"
        if events:
            lines = []
            for ev in events[:50]:  # ReAct ë‹¨ê³„ì—ëŠ” ì¡°ê¸ˆ ë” ë§ì€ ì´ë²¤íŠ¸ë¥¼ í—ˆìš©
                ev_type = ev.get("event_type", "")
                status = ev.get("status", "")
                crew_type = ev.get("crew_type", "")
                ts = ev.get("timestamp", "")
                data_str = ""
                try:
                    data = ev.get("data", {})
                    data_str = json.dumps(data, ensure_ascii=False)
                    if len(data_str) > 300:
                        data_str = data_str[:300] + "...(truncated)"
                except Exception:
                    data_str = str(ev.get("data", ""))[:300]
                lines.append(
                    f"- time={ts}, type={ev_type}, status={status}, crew_type={crew_type}, data={data_str}"
                )
            events_summary = "\n".join(lines)

        # ì…ë ¥ ë°ì´í„° í¬ë§·íŒ… (í‘œì¤€ ReAct í”„ë¡¬í”„íŠ¸ëŠ” 'input' ë³€ìˆ˜ë¥¼ ì‚¬ìš©)
        input_text = f"""ë‹¤ìŒ í”¼ë“œë°±ì„ ì²˜ë¦¬í•´ì£¼ì„¸ìš”:

**í”¼ë“œë°± ë‚´ìš©:**
{feedback_content}

**ì—ì´ì „íŠ¸ ì •ë³´:**
{agent_info_text}

**ì‘ì—… ì§€ì‹œì‚¬í•­:**
{task_description}

**í•´ë‹¹ ì‘ì—…ì˜ ì´ë²¤íŠ¸ ë¡œê·¸ (ì‹œê°„ìˆœ, ì‹¤ì œ ìŠ¤í‚¬/ë„êµ¬ ì‚¬ìš© ë‚´ì—­):**
{events_summary}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ Thought â†’ Action â†’ Observation ì‚¬ì´í´ì„ ë°˜ë³µí•˜ì—¬ í”¼ë“œë°±ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
ìµœì¢…ì ìœ¼ë¡œ Final Answerë¡œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë³´ê³ í•˜ì„¸ìš”."""
        
        # ì—ì´ì „íŠ¸ ì‹¤í–‰
        input_data = {
            "input": input_text
        }
        
        log(f"ğŸ”„ ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œì‘...")
        try:
            result = await agent_executor.ainvoke(input_data)
        except Exception as agent_error:
            # ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê¹… í›„ ê³„ì† ì§„í–‰
            log(f"âŒ ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: {str(agent_error)[:300]}...")
            handle_error("ReActì—ì´ì „íŠ¸ì‹¤í–‰", agent_error)
            # ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë°œìƒì‹œí‚¤ì§€ ì•Šê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜í•˜ì—¬ í´ë§ ê³„ì† ì§„í–‰
            return {
                "output": f"í”¼ë“œë°± ì²˜ë¦¬ ì‹¤íŒ¨ (ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨)",
                "intermediate_steps": [],
                "agent_id": agent_id,
                "error": str(agent_error)
            }
        
        # ê²°ê³¼ ì²˜ë¦¬
        output = result.get("output", "")
        intermediate_steps = result.get("intermediate_steps", [])

        # âœ… ì‹¤í–‰ ê²°ê³¼ê°€ "ë§ë¡œë§Œ ê²°ë¡ "ì´ê³  ì‹¤ì œ commitì´ ì—†ëŠ” ê²½ìš°ë¥¼ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
        committed_tools = {"commit_to_memory", "commit_to_dmn_rule", "commit_to_skill"}
        used_tools = []
        commit_failures: List[str] = []
        commit_successes: List[str] = []
        for step in intermediate_steps or []:
            action = step[0] if isinstance(step, (list, tuple)) and len(step) > 0 else None
            tool_name = getattr(action, "tool", None) if action else None
            if tool_name:
                used_tools.append(str(tool_name))

            # commit ë„êµ¬ ê²°ê³¼ê°€ âŒì´ë©´ "ë³€ê²½ ì´ë ¥ ì—†ìŒ = ì‹¤íŒ¨"ë¡œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.
            if tool_name in committed_tools:
                observation = step[1] if isinstance(step, (list, tuple)) and len(step) > 1 else None
                obs_text = str(observation) if observation is not None else ""
                if "âŒ" in obs_text:
                    commit_failures.append(f"{tool_name}: {obs_text[:200]}")
                elif "âœ…" in obs_text:
                    commit_successes.append(str(tool_name))

        did_commit = len(commit_successes) > 0
        # heuristic: outputì´ ì €ì¥/ìƒì„±/ìˆ˜ì •/ì‚­ì œë¥¼ ë§í•˜ê³  ìˆëŠ”ë° commitì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨
        output_lower = (output or "").lower()
        claims_mutation = any(
            kw in output_lower
            for kw in [
                "create",
                "update",
                "delete",
                "ì €ì¥",
                "ìƒì„±",
                "ìˆ˜ì •",
                "ì‚­ì œ",
                "ì—…ë°ì´íŠ¸",
                "ì»¤ë°‹",
            ]
        )
        claims_ignore = any(
            kw in output_lower
            for kw in [
                "ignore",
                "ë¬´ì‹œ",
                "ì €ì¥í•˜ì§€",
                "ì²˜ë¦¬í•˜ì§€",
            ]
        )
        if (not did_commit) and claims_mutation and (not claims_ignore):
            err = (
                "ReAct ì—ì´ì „íŠ¸ê°€ ì €ì¥/ìˆ˜ì •/ì‚­ì œ ê²°ë¡ ì„ ëƒˆì§€ë§Œ commit ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ "
                "ì‹¤ì œ ë³€ê²½ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (no_commit)"
            )
            log(f"âŒ {err}")
            return {
                "output": output,
                "intermediate_steps": intermediate_steps,
                "agent_id": agent_id,
                "error": err,
                "used_tools": used_tools,
            }

        # commit ë„êµ¬ë¥¼ í˜¸ì¶œí–ˆì§€ë§Œ ì‹¤íŒ¨(âŒ)í•œ ê²½ìš°: ë³€ê²½ ì´ë ¥ ë¯¸ê¸°ë¡ì´ë¯€ë¡œ ë¬´ì¡°ê±´ ì‹¤íŒ¨
        if commit_failures:
            err = (
                "commit ë„êµ¬ í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ì—¬ ë³€ê²½ ì´ë ¥ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (commit_failed) "
                + " | ".join(commit_failures[:2])
            )
            log(f"âŒ {err}")
            return {
                "output": output,
                "intermediate_steps": intermediate_steps,
                "agent_id": agent_id,
                "error": err,
                "used_tools": used_tools,
                "commit_failures": commit_failures,
            }
        
        log(f"âœ… ReAct ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì™„ë£Œ")
        log(f"   ìµœì¢… ì¶œë ¥: {output[:200]}...")
        log(f"   ì¤‘ê°„ ë‹¨ê³„ ìˆ˜: {len(intermediate_steps)}")
        
        # ì¤‘ê°„ ë‹¨ê³„ ë¡œê¹… (ë””ë²„ê¹…ìš©)
        for idx, step in enumerate(intermediate_steps, start=1):
            action = step[0] if len(step) > 0 else None
            observation = step[1] if len(step) > 1 else None
            if action:
                log(f"   ë‹¨ê³„ {idx}: {action.tool} - {str(observation)[:100]}...")
        
        return {
            "output": output,
            "intermediate_steps": intermediate_steps,
            "agent_id": agent_id,
            "used_tools": used_tools,
            "did_commit": did_commit,
            "commit_successes": commit_successes,
        }
        
    except Exception as e:
        # ìµœì¢… í´ë°±: ì—ëŸ¬ë¥¼ ë¡œê¹…ë§Œ í•˜ê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜í•˜ì—¬ í´ë§ ê³„ì† ì§„í–‰
        log(f"âŒ ReAct í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬: {str(e)[:300]}...")
        handle_error("ReActí”¼ë“œë°±ì²˜ë¦¬", e)
        # ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë°œìƒì‹œí‚¤ì§€ ì•Šê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜
        return {
            "output": f"í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ",
            "intermediate_steps": [],
            "agent_id": agent_id,
            "error": str(e)
        }

