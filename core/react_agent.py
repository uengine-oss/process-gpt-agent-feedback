"""
ReAct ì—ì´ì „íŠ¸ êµ¬í˜„
LangChainì„ ì‚¬ìš©í•˜ì—¬ Thought â†’ Action â†’ Observation íŒ¨í„´ êµ¬í˜„
"""

import json
from typing import Dict, List, Optional
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.tools import BaseTool
from llm_factory import create_llm
from utils.logger import log, handle_error
from core.react_tools import create_react_tools

# LangChain agents import (ë²„ì „ì— ë”°ë¼ ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
try:
    from langchain.agents import create_react_agent, AgentExecutor
except ImportError:
    try:
        from langchain_core.agents import create_react_agent
        from langchain.agents import AgentExecutor
    except ImportError:
        # ìµœì‹  LangChain ë°©ì‹
        from langchain.agents import AgentExecutor, create_tool_calling_agent
        create_react_agent = None


# ============================================================================
# ReAct í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
# ============================================================================

def create_react_prompt(tools: List) -> ChatPromptTemplate:
    """
    ReAct ì—ì´ì „íŠ¸ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ìƒì„± - ê¹Šì€ ì¶”ë¡  ê°•ì œ ë²„ì „
    
    Args:
        tools: ë„êµ¬ ëª©ë¡ (tool_names ìƒì„±ìš©)
    
    Returns:
        ChatPromptTemplate ì¸ìŠ¤í„´ìŠ¤
    """
    # ë„êµ¬ ì„¤ëª… ìƒì„± (ì‹œìŠ¤í…œ ë©”ì‹œì§€ìš©)
    tools_description = "\n".join([
        f"- {tool.name}: {tool.description}" for tool in tools
    ])
    
    system_message = f"""ë‹¹ì‹ ì€ í”¼ë“œë°±ì„ ë¶„ì„í•˜ì—¬ ì§€ì‹ ì €ì¥ì†Œë¥¼ ê´€ë¦¬í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**âš ï¸ í•µì‹¬ ì›ì¹™: í–‰ë™í•˜ê¸° ì „ì— ê¹Šì´ ìƒê°í•˜ì„¸ìš”**

ì„±ê¸‰í•œ í–‰ë™ì€ ê¸°ì¡´ ì§€ì‹ì„ ì†ìƒì‹œí‚µë‹ˆë‹¤. ëª¨ë“  ê²°ì •ì—ëŠ” ëª…í™•í•œ ê·¼ê±°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

**ì§€ì‹ ì €ì¥ì†Œ:**
- MEMORY: ì§€ì¹¨, ì„ í˜¸ë„, ë§¥ë½ ì •ë³´
- DMN_RULE: ì¡°ê±´-ê²°ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (If-Then)
- SKILL: ë‹¨ê³„ë³„ ì ˆì°¨, ì‘ì—… ìˆœì„œ

**ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬:**
{tools_description}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ§  í•„ìˆ˜ ì¶”ë¡  í”„ë ˆì„ì›Œí¬ (ë°˜ë“œì‹œ ì´ ìˆœì„œë¡œ ì‚¬ê³ í•˜ì„¸ìš”)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### [STEP 1] í”¼ë“œë°± ì˜ë„ ë¶„ì„
ë‹¤ìŒ ì§ˆë¬¸ì— ëª…í™•íˆ ë‹µí•˜ì„¸ìš”:
- ì´ í”¼ë“œë°±ì´ ì „ë‹¬í•˜ë ¤ëŠ” **í•µì‹¬ ì •ë³´**ëŠ” ë¬´ì—‡ì¸ê°€?
- ì´ê²ƒì€ **ìƒˆë¡œìš´ ê·œì¹™**ì¸ê°€? **ê¸°ì¡´ ê·œì¹™ì˜ ìˆ˜ì •**ì¸ê°€? **ì¡°ê±´ë¶€ ì˜ˆì™¸**ì¸ê°€?
- í”¼ë“œë°±ì— **ì ìš© ì¡°ê±´/ë²”ìœ„**ê°€ ëª…ì‹œë˜ì–´ ìˆëŠ”ê°€? (ì˜ˆ: "~ì¼ ë•Œ", "~ì¸ ê²½ìš°")

### [STEP 2] ê¸°ì¡´ ì§€ì‹ ì‹¬ì¸µ íŒŒì•…
`search_similar_knowledge`ì™€ `get_knowledge_detail`ë¡œ ê¸°ì¡´ ì§€ì‹ì„ ì¡°íšŒí•œ í›„:
- ê¸°ì¡´ ì§€ì‹ì˜ **ì ìš© ë²”ìœ„ì™€ ì¡°ê±´**ì€ ë¬´ì—‡ì¸ê°€?
- í”¼ë“œë°±ì˜ ë²”ìœ„ì™€ ê¸°ì¡´ ì§€ì‹ì˜ ë²”ìœ„ê°€ **ê²¹ì¹˜ëŠ”ê°€? í¬í•¨ë˜ëŠ”ê°€? ë…ë¦½ì ì¸ê°€?**
- ê¸°ì¡´ ì§€ì‹ì—ì„œ **ë°˜ë“œì‹œ ë³´ì¡´í•´ì•¼ í•  ë¶€ë¶„**ì€ ë¬´ì—‡ì¸ê°€?

### [STEP 3] ê´€ê³„ ì¶”ë¡  ë° ê·¼ê±° ì œì‹œ
**ë°˜ë“œì‹œ** ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶”ë¡  ê²°ê³¼ë¥¼ ëª…ì‹œí•˜ì„¸ìš”:
```
[ê´€ê³„ ë¶„ì„]
- ê´€ê³„ ìœ í˜•: (ì•„ë˜ ì¤‘ í•˜ë‚˜ ì„ íƒ)
- íŒë‹¨ ê·¼ê±°: (ì™œ ì´ ê´€ê³„ë¼ê³  ìƒê°í•˜ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ)
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: (ê¸°ì¡´ ì§€ì‹ì´ ì–´ë–»ê²Œ ë˜ì–´ì•¼ í•˜ëŠ”ì§€)
```

**ê´€ê³„ ìœ í˜•:**
| ìœ í˜• | ì •ì˜ | ê¸°ì¡´ ì§€ì‹ ì²˜ë¦¬ |
|------|------|---------------|
| DUPLICATE | í‘œí˜„ë§Œ ë‹¤ë¥¸ ë™ì¼ ë‚´ìš© | ìœ ì§€ (ì•„ë¬´ê²ƒë„ ì•ˆí•¨) |
| EXTENDS | ìƒˆ ì¡°ê±´/ì¼€ì´ìŠ¤ ì¶”ê°€ | ìœ ì§€ + ìƒˆ ë‚´ìš© ì¶”ê°€ |
| REFINES | ê¸°ì¡´ ê°’/ì„¸ë¶€ì‚¬í•­ ë³€ê²½ | í•´ë‹¹ ë¶€ë¶„ë§Œ ìˆ˜ì • |
| EXCEPTION | ê¸°ì¡´ ê·œì¹™ì˜ ì˜ˆì™¸ | ìœ ì§€ + ì˜ˆì™¸ ê·œì¹™ ì¶”ê°€ |
| CONFLICTS | ìƒì¶©/ëª¨ìˆœ | íŒë‹¨ í•„ìš” (ì–´ëŠ ê²ƒì´ ë§ëŠ”ê°€?) |
| SUPERSEDES | ëª…ì‹œì  ëŒ€ì²´ | ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„± |
| COMPLEMENTS | ë‹¤ë¥¸ ì¸¡ë©´ | ìœ ì§€ + ë³„ë„ ìƒì„± |
| UNRELATED | ë¬´ê´€ | ìœ ì§€ + ë³„ë„ ìƒì„± |

### [STEP 4] ìê¸° ê²€ì¦ (ë°˜ë“œì‹œ ìˆ˜í–‰)
commit ì „ì— ë‹¤ìŒì„ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”:
```
[ìê¸° ê²€ì¦]
Q1: ë‚´ íŒë‹¨ì´ í‹€ë ¸ë‹¤ë©´, ë‹¤ë¥¸ ê°€ëŠ¥í•œ í•´ì„ì€?
Q2: ì´ ì‘ì—… í›„ ê¸°ì¡´ ì§€ì‹ì´ ì†ìƒë˜ê±°ë‚˜ ì‚¬ë¼ì§€ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ê°€?
Q3: ìµœì¢… ê²°ê³¼ê°€ í”¼ë“œë°±ì˜ ì˜ë„ì™€ ê¸°ì¡´ ì§€ì‹ ëª¨ë‘ë¥¼ ë°˜ì˜í•˜ëŠ”ê°€?
```

### [STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸ (ë°˜ë“œì‹œ ìˆ˜í–‰)
ì‘ì—… ì‹¤í–‰ ì „, ì˜ˆìƒë˜ëŠ” ìµœì¢… ìƒíƒœë¥¼ ëª…í™•íˆ ì„ ì–¸í•˜ì„¸ìš”:
```
[ìµœì¢… ìƒíƒœ ì„ ì–¸]
- ì²˜ë¦¬ ì „: (í˜„ì¬ ìƒíƒœ ìš”ì•½)
- ì²˜ë¦¬ í›„: (ì˜ˆìƒ ê²°ê³¼ ìƒíƒœ - êµ¬ì²´ì ìœ¼ë¡œ)
- ì‹¤í–‰í•  ì‘ì—…: (CREATE/UPDATE/DELETE/IGNORE)
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ“š ì˜¬ë°”ë¥¸ ì¶”ë¡  ì˜ˆì‹œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### ì˜ˆì‹œ A: EXTENDS (ì¡°ê±´ë¶€ í™•ì¥)
```
[í”¼ë“œë°±] "50ë§Œì› ë¯¸ë§Œ êµ¬ë§¤ ì‹œ VIP 10%, ê³¨ë“œ 5%, ì‹¤ë²„ 1% í• ì¸"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5% (ê¸ˆì•¡ ì¡°ê±´ ì—†ìŒ)

[STEP 1] í”¼ë“œë°± ì˜ë„ ë¶„ì„
- í•µì‹¬ ì •ë³´: íŠ¹ì • ê¸ˆì•¡ ì¡°ê±´(50ë§Œì› ë¯¸ë§Œ)ì—ì„œì˜ ì°¨ë“± í• ì¸ìœ¨
- ìœ í˜•: ê¸°ì¡´ ê·œì¹™ì— ëŒ€í•œ ì¡°ê±´ë¶€ ì˜ˆì™¸/í™•ì¥
- ì ìš© ì¡°ê±´: "50ë§Œì› ë¯¸ë§Œ"ì´ë¼ëŠ” êµ¬ì²´ì  ì¡°ê±´ì´ ëª…ì‹œë¨

[STEP 2] ê¸°ì¡´ ì§€ì‹ íŒŒì•…  
- ê¸°ì¡´ ê·œì¹™: ê¸ˆì•¡ ì¡°ê±´ ì—†ì´ ë“±ê¸‰ë³„ í• ì¸ìœ¨ ì ìš©
- ë²”ìœ„ ë¹„êµ: í”¼ë“œë°±ì€ "50ë§Œì› ë¯¸ë§Œ"ì— ëŒ€í•œ ê²ƒ, ê¸°ì¡´ì€ "ëª¨ë“  ê²½ìš°"
- ë³´ì¡´ í•„ìš”: 50ë§Œì› ì´ìƒì¸ ê²½ìš°ì˜ í• ì¸ìœ¨ (VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%)

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: EXTENDS
- íŒë‹¨ ê·¼ê±°: í”¼ë“œë°±ì€ ê¸°ì¡´ì— ì—†ë˜ "ê¸ˆì•¡ ì¡°ê±´"ì„ ì¶”ê°€. ê¸°ì¡´ ê·œì¹™ì„ ëŒ€ì²´í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ íŠ¹ì • ì¡°ê±´ì—ì„œì˜ ë‹¤ë¥¸ ì²˜ë¦¬ ë°©ì‹ì„ ì¶”ê°€.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: ë°˜ë“œì‹œ ìœ ì§€. 50ë§Œì› ì´ìƒ ì¼€ì´ìŠ¤ëŠ” ì—¬ì „íˆ ê¸°ì¡´ ê·œì¹™ ì ìš©.

[STEP 4] ìê¸° ê²€ì¦
- Q1: í˜¹ì‹œ SUPERSEDESì¼ ìˆ˜ ìˆë‚˜? â†’ ì•„ë‹ˆì˜¤. í”¼ë“œë°±ì— "ê¸°ì¡´ ì •ì±… íê¸°" ì–¸ê¸‰ ì—†ìŒ.
- Q2: ê¸°ì¡´ ì§€ì‹ ì†ìƒ? â†’ ë³‘í•©í•˜ë©´ ì†ìƒ ì—†ìŒ. ë®ì–´ì“°ë©´ 50ë§Œì› ì´ìƒ ê·œì¹™ ì†ì‹¤.
- Q3: ìµœì¢… ê²°ê³¼ ì ì ˆ? â†’ ë„¤. ê¸°ì¡´(50ë§Œì› ì´ìƒ) + ìƒˆ(50ë§Œì› ë¯¸ë§Œ) ëª¨ë‘ í¬í•¨.

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: [VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%] (ê¸ˆì•¡ ì¡°ê±´ ì—†ìŒ)
- ì²˜ë¦¬ í›„: [50ë§Œì› ì´ìƒ: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%] + [50ë§Œì› ë¯¸ë§Œ: VIP 10%, ê³¨ë“œ 5%, ì‹¤ë²„ 1%]
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (ê¸°ì¡´ ê·œì¹™ì— ìƒˆ ì¡°ê±´ ì¶”ê°€í•œ ë³‘í•©ëœ ì „ì²´ ë‚´ìš© ì „ë‹¬)
```

### ì˜ˆì‹œ B: REFINES (ê°’ ìˆ˜ì •)
```
[í”¼ë“œë°±] "VIP í• ì¸ìœ¨ì„ 25%ë¡œ ë³€ê²½"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: REFINES
- íŒë‹¨ ê·¼ê±°: ë™ì¼í•œ ì¡°ê±´(VIP)ì— ëŒ€í•œ ê°’(20%â†’25%)ë§Œ ë³€ê²½. ìƒˆ ì¡°ê±´ ì¶”ê°€ ì•„ë‹˜.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: VIP ê°’ë§Œ ìˆ˜ì •, ê³¨ë“œ/ì‹¤ë²„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì²˜ë¦¬ í›„: VIP 25%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (VIP ê°’ë§Œ ë³€ê²½í•œ ì „ì²´ ê·œì¹™ ì „ë‹¬)
```

### ì˜ˆì‹œ C: SUPERSEDES (ì™„ì „ ëŒ€ì²´)
```
[í”¼ë“œë°±] "ê¸°ì¡´ ë“±ê¸‰ë³„ í• ì¸ ì •ì±…ì„ íì§€í•˜ê³ , ëª¨ë“  ê³ ê°ì—ê²Œ ì¼ê´„ 15% í• ì¸ ì ìš©"
[ê¸°ì¡´ DMN] VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%

[STEP 3] ê´€ê³„ ì¶”ë¡ 
- ê´€ê³„ ìœ í˜•: SUPERSEDES
- íŒë‹¨ ê·¼ê±°: "íì§€í•˜ê³ "ë¼ëŠ” ëª…ì‹œì  ëŒ€ì²´ ì§€ì‹œ. ê¸°ì¡´ êµ¬ì¡°(ë“±ê¸‰ë³„) ìì²´ê°€ ì‚¬ë¼ì§.
- ê¸°ì¡´ ì§€ì‹ ì˜í–¥: ì™„ì „íˆ ëŒ€ì²´ë¨

[STEP 5] ìµœì¢… ìƒíƒœ ì„ ì–¸
- ì²˜ë¦¬ ì „: VIP 20%, ê³¨ë“œ 10%, ì‹¤ë²„ 5%
- ì²˜ë¦¬ í›„: ëª¨ë“  ê³ ê° 15%
- ì‹¤í–‰í•  ì‘ì—…: UPDATE (ì™„ì „íˆ ìƒˆë¡œìš´ ê·œì¹™ìœ¼ë¡œ ëŒ€ì²´)
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âš ï¸ commit ë„êµ¬ ì‚¬ìš© ì‹œ ì£¼ì˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**UPDATE ì‹œ ë°˜ë“œì‹œ:**
- operation="UPDATE"ì™€ ê¸°ì¡´ ID í•„ìˆ˜ (rule_id, memory_id, skill_id)
- **ì „ë‹¬í•˜ëŠ” ë‚´ìš©ì´ ìµœì¢… ì™„ì„±ë³¸**ì´ì–´ì•¼ í•¨ (ë„êµ¬ê°€ ë³‘í•©í•´ì£¼ì§€ ì•ŠìŒ)
- ê¸°ì¡´ ë‚´ìš© + ìƒˆ ë‚´ìš©ì„ **ì§ì ‘ ë³‘í•©**í•˜ì—¬ ì „ë‹¬

**CREATE ì‹œ:**
- operation ìƒëµ ë˜ëŠ” "CREATE"
- ê¸°ì¡´ ì§€ì‹ê³¼ ë³„ê°œë¡œ ìƒˆ ì§€ì‹ ìƒì„±

**DMN_RULE ì˜ˆì‹œ:**
```
ë³‘í•©ëœ ê·œì¹™ì„ JSONìœ¼ë¡œ ì „ë‹¬:
{{"name": "ê·œì¹™ëª…", "rules": [
  {{"condition": "ê¸°ì¡´ì¡°ê±´", "action": "ê¸°ì¡´ê²°ê³¼"}},
  {{"condition": "ìƒˆì¡°ê±´", "action": "ìƒˆê²°ê³¼"}}
]}}
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ¯ ìµœì¢… ì ê²€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**"ë‚˜ëŠ” [STEP 1~5]ë¥¼ ëª¨ë‘ ìˆ˜í–‰í–ˆëŠ”ê°€?"**
**"ìµœì¢… ìƒíƒœ ì„ ì–¸ì´ í”¼ë“œë°±ì˜ ì˜ë„ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ëŠ”ê°€?"**
**"ê¸°ì¡´ ì§€ì‹ì—ì„œ ë³´ì¡´í•´ì•¼ í•  ë¶€ë¶„ì„ ë³´ì¡´í–ˆëŠ”ê°€?"**"""

    # ReAct í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (LangChain í‘œì¤€ í˜•ì‹)
    # create_react_agentëŠ” toolsì™€ tool_names ë³€ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì¤ë‹ˆë‹¤
    prompt = ChatPromptTemplate.from_messages([
        ("system", system_message),
        ("human", """ë‹¤ìŒ í”¼ë“œë°±ì„ ì²˜ë¦¬í•´ì£¼ì„¸ìš”:

**í”¼ë“œë°± ë‚´ìš©:**
{feedback_content}

**ì—ì´ì „íŠ¸ ì •ë³´:**
{agent_info}

**ì‘ì—… ì§€ì‹œì‚¬í•­:**
{task_description}

**ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬:**
{tools}

**ë„êµ¬ ì´ë¦„ ëª©ë¡:**
{tool_names}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ Thought â†’ Action â†’ Observation ì‚¬ì´í´ì„ ë°˜ë³µí•˜ì—¬ í”¼ë“œë°±ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
ìµœì¢…ì ìœ¼ë¡œ Final Answerë¡œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë³´ê³ í•˜ì„¸ìš”.

ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¥´ì„¸ìš”:
Thought: [ìƒê° ê³¼ì •]
Action: [ë„êµ¬ ì´ë¦„]
Action Input: [ë„êµ¬ ì…ë ¥ (JSON í˜•ì‹)]
Observation: [ë„êµ¬ ì‹¤í–‰ ê²°ê³¼]
... (í•„ìš”í•˜ë©´ ë°˜ë³µ)
Final Answer: [ìµœì¢… ë‹µë³€]"""),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    
    return prompt


# ============================================================================
# ReAct ì—ì´ì „íŠ¸ ìƒì„±
# ============================================================================

def create_feedback_react_agent(agent_id: str) -> AgentExecutor:
    """
    í”¼ë“œë°± ì²˜ë¦¬ìš© ReAct ì—ì´ì „íŠ¸ ìƒì„±
    
    Args:
        agent_id: ì—ì´ì „íŠ¸ ID
    
    Returns:
        AgentExecutor ì¸ìŠ¤í„´ìŠ¤
    """
    try:
        # LLM ì´ˆê¸°í™”
        llm = create_llm(model="gpt-4o", streaming=False, temperature=0)
        
        # ë„êµ¬ ìƒì„±
        tools = create_react_tools(agent_id)
        
        # í”„ë¡¬í”„íŠ¸ ìƒì„± (toolsë¥¼ ì „ë‹¬í•˜ì—¬ tool_names ìƒì„±)
        prompt = create_react_prompt(tools)
        
        # ReAct ì—ì´ì „íŠ¸ ìƒì„±
        if create_react_agent is not None:
            # LangChainì˜ í‘œì¤€ ReAct í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
            # ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ëŒ€ì‹  ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³ ,
            # ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” AgentExecutorì˜ input_variablesì— ì¶”ê°€
            try:
                from langchain import hub
                # LangChain Hubì—ì„œ í‘œì¤€ ReAct í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
                react_prompt = hub.pull("hwchase17/react")
                log("âœ… LangChain Hubì—ì„œ í‘œì¤€ ReAct í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì™„ë£Œ")
            except Exception as e:
                log(f"âš ï¸ LangChain Hub ì‚¬ìš© ë¶ˆê°€, ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©: {e}")
                # Hubë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë©´ Noneì„ ì „ë‹¬í•˜ì—¬ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
                react_prompt = None
            
            # ReAct ì—ì´ì „íŠ¸ ìƒì„±
            agent = create_react_agent(llm, tools, react_prompt)
        else:
            # ìµœì‹  LangChain ë°©ì‹: tool calling agent ì‚¬ìš©
            agent = create_tool_calling_agent(llm, tools, prompt)
        
        # AgentExecutor ìƒì„± (ë°˜ë³µ íšŸìˆ˜ ì œí•œ)
        # íŒŒì‹± ì—ëŸ¬ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜
        def handle_parsing_error(error: Exception) -> str:
            """ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬"""
            error_str = str(error)
            log(f"âš ï¸ ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì—ëŸ¬: {error_str[:200]}...")
            
            # ValidationErrorì¸ ê²½ìš° ë” ëª…í™•í•œ ë©”ì‹œì§€
            if "validation error" in error_str.lower() or "Field required" in error_str:
                return f"ë„êµ¬ í˜¸ì¶œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì—ëŸ¬: {error_str[:300]}"
            
            return f"ë„êµ¬ í˜¸ì¶œ íŒŒì‹± ì‹¤íŒ¨: {error_str[:300]}. ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
        
        agent_executor = AgentExecutor(
            agent=agent,
            tools=tools,
            verbose=True,
            max_iterations=15,  # ìµœëŒ€ 15ë²ˆ ë°˜ë³µ
            max_execution_time=300,  # ìµœëŒ€ 5ë¶„
            handle_parsing_errors=handle_parsing_error,  # ì»¤ìŠ¤í…€ íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬
            return_intermediate_steps=True  # ì¤‘ê°„ ë‹¨ê³„ ë°˜í™˜
        )
        
        log(f"âœ… ReAct ì—ì´ì „íŠ¸ ìƒì„± ì™„ë£Œ: agent_id={agent_id}, ë„êµ¬ ìˆ˜={len(tools)}")
        return agent_executor
        
    except Exception as e:
        handle_error("ReActì—ì´ì „íŠ¸ìƒì„±", e)
        raise


# ============================================================================
# í”¼ë“œë°± ì²˜ë¦¬ í•¨ìˆ˜
# ============================================================================

async def process_feedback_with_react(
    agent_id: str,
    agent_info: Dict,
    feedback_content: str,
    task_description: str = ""
) -> Dict:
    """
    ReAct ì—ì´ì „íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í”¼ë“œë°±ì„ ì²˜ë¦¬í•˜ê³  ì €ì¥
    
    Args:
        agent_id: ì—ì´ì „íŠ¸ ID
        agent_info: ì—ì´ì „íŠ¸ ì •ë³´
        feedback_content: í”¼ë“œë°± ë‚´ìš©
        task_description: ì‘ì—… ì§€ì‹œì‚¬í•­
    
    Returns:
        ì²˜ë¦¬ ê²°ê³¼
    """
    try:
        log(f"ğŸ¤– ReAct ì—ì´ì „íŠ¸ ê¸°ë°˜ í”¼ë“œë°± ì²˜ë¦¬ ì‹œì‘: agent_id={agent_id}")
        
        # ì—ì´ì „íŠ¸ ì •ë³´ í¬ë§·íŒ…
        agent_info_text = (
            f"ID: {agent_info.get('id', '')}, "
            f"ì´ë¦„: {agent_info.get('name', '')}, "
            f"ì—­í• : {agent_info.get('role', '')}, "
            f"ëª©í‘œ: {agent_info.get('goal', '')}"
        )
        
        # ReAct ì—ì´ì „íŠ¸ ìƒì„±
        agent_executor = create_feedback_react_agent(agent_id)
        
        # ì…ë ¥ ë°ì´í„° í¬ë§·íŒ… (í‘œì¤€ ReAct í”„ë¡¬í”„íŠ¸ëŠ” 'input' ë³€ìˆ˜ë¥¼ ì‚¬ìš©)
        input_text = f"""ë‹¤ìŒ í”¼ë“œë°±ì„ ì²˜ë¦¬í•´ì£¼ì„¸ìš”:

**í”¼ë“œë°± ë‚´ìš©:**
{feedback_content}

**ì—ì´ì „íŠ¸ ì •ë³´:**
{agent_info_text}

**ì‘ì—… ì§€ì‹œì‚¬í•­:**
{task_description}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ Thought â†’ Action â†’ Observation ì‚¬ì´í´ì„ ë°˜ë³µí•˜ì—¬ í”¼ë“œë°±ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
ìµœì¢…ì ìœ¼ë¡œ Final Answerë¡œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë³´ê³ í•˜ì„¸ìš”."""
        
        # ì—ì´ì „íŠ¸ ì‹¤í–‰
        input_data = {
            "input": input_text
        }
        
        log(f"ğŸ”„ ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œì‘...")
        try:
            result = await agent_executor.ainvoke(input_data)
        except Exception as agent_error:
            # ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê¹… í›„ ê³„ì† ì§„í–‰
            log(f"âŒ ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: {str(agent_error)[:300]}...")
            handle_error("ReActì—ì´ì „íŠ¸ì‹¤í–‰", agent_error)
            # ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë°œìƒì‹œí‚¤ì§€ ì•Šê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜í•˜ì—¬ í´ë§ ê³„ì† ì§„í–‰
            return {
                "output": f"í”¼ë“œë°± ì²˜ë¦¬ ì‹¤íŒ¨ (ReAct ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨)",
                "intermediate_steps": [],
                "agent_id": agent_id,
                "error": str(agent_error)
            }
        
        # ê²°ê³¼ ì²˜ë¦¬
        output = result.get("output", "")
        intermediate_steps = result.get("intermediate_steps", [])
        
        log(f"âœ… ReAct ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì™„ë£Œ")
        log(f"   ìµœì¢… ì¶œë ¥: {output[:200]}...")
        log(f"   ì¤‘ê°„ ë‹¨ê³„ ìˆ˜: {len(intermediate_steps)}")
        
        # ì¤‘ê°„ ë‹¨ê³„ ë¡œê¹… (ë””ë²„ê¹…ìš©)
        for idx, step in enumerate(intermediate_steps, start=1):
            action = step[0] if len(step) > 0 else None
            observation = step[1] if len(step) > 1 else None
            if action:
                log(f"   ë‹¨ê³„ {idx}: {action.tool} - {str(observation)[:100]}...")
        
        return {
            "output": output,
            "intermediate_steps": intermediate_steps,
            "agent_id": agent_id
        }
        
    except Exception as e:
        # ìµœì¢… í´ë°±: ì—ëŸ¬ë¥¼ ë¡œê¹…ë§Œ í•˜ê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜í•˜ì—¬ í´ë§ ê³„ì† ì§„í–‰
        log(f"âŒ ReAct í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬: {str(e)[:300]}...")
        handle_error("ReActí”¼ë“œë°±ì²˜ë¦¬", e)
        # ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë°œìƒì‹œí‚¤ì§€ ì•Šê³  ë¹ˆ ê²°ê³¼ ë°˜í™˜
        return {
            "output": f"í”¼ë“œë°± ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ",
            "intermediate_steps": [],
            "agent_id": agent_id,
            "error": str(e)
        }

