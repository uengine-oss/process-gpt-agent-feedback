import json
import os
from typing import Dict
from llm_factory import create_llm
from utils.logger import log, handle_error
from dotenv import load_dotenv

load_dotenv()

# ============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================================================

def clean_json_response(content: str) -> str:
    """LLM ì‘ë‹µì—ì„œ ë°±í‹±ê³¼ json í‚¤ì›Œë“œ ì œê±°"""
    content = content.replace("```json", "").replace("```", "")
    return content.strip()

# ============================================================================
# í•™ìŠµ ë¼ìš°íŒ…
# ============================================================================

async def route_learning(candidate: Dict) -> Dict:
    """
    í•™ìŠµ í›„ë³´ë¥¼ ë°›ì•„ì„œ ì €ì¥ ëŒ€ìƒ(MEMORY / DMN_RULE / SKILL / MIXED)ì„ ê²°ì •
    
    Args:
        candidate: {
            "content": "í†µí•©ëœ í”¼ë“œë°± ë³¸ë¬¸",
            "intent_hint": "íŒë‹¨ ê¸°ì¤€ì¸ì§€ / ì ˆì°¨ì¸ì§€ / ì§€ì¹¨ì¸ì§€ì— ëŒ€í•œ ìš”ì•½ íŒíŠ¸"
        }
    
    Returns:
        {
            "target": "MEMORY | DMN_RULE | SKILL | MIXED",
            "artifacts": {
                "memory": "...",          # optional
                "dmn": {...},             # optional
                "skill": {...}            # optional
            }
        }
    """
    
    llm = create_llm(model="gpt-4o", streaming=False, temperature=0)
    
    content = candidate.get("content", "")
    intent_hint = candidate.get("intent_hint", "")
    
    prompt = f"""
ë‹¤ìŒ í”¼ë“œë°±ì„ ë¶„ì„í•˜ì—¬ í•™ìŠµ ìœ í˜•ì„ ë¶„ë¥˜í•˜ê³  ì ì ˆí•œ ì €ì¥ì†Œë¥¼ ê²°ì •í•´ì£¼ì„¸ìš”.

**í”¼ë“œë°± ë‚´ìš©:**
{content}

**ì˜ë„ íŒíŠ¸:**
{intent_hint}

**ì§€ì‹ ì €ì¥ì†Œ ë¶„ë¥˜ ê¸°ì¤€:**

í”¼ë“œë°± ë‚´ìš©ì— ë”°ë¼ ë‹¤ìŒ ì„¸ ê°€ì§€ ì €ì¥ì†Œ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:

1. **MEMORY (ê¸°ì–µ) â†’ mem0 ì €ì¥ì†Œ**
   - ì§€ì¹¨, ì„ í˜¸ë„, ë§¥ë½ì  ì£¼ì˜ì‚¬í•­, ê²½í—˜ ê¸°ë°˜ ì •ë³´
   - ê°œì¸ì  ì„ í˜¸ë‚˜ í”„ë¡œì íŠ¸ë³„ íŠ¹ì„± ì •ë³´
   - "ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” X ë°©ì‹ì„ ì„ í˜¸í•œë‹¤"
   - "ê³¼ê±°ì— Y ë°©ì‹ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤"
   - "ì‚¬ìš©ìëŠ” ê°„ê²°í•œ ì„¤ëª…ì„ ì„ í˜¸í•œë‹¤"
   - ì¼ë°˜ì ì¸ ê°€ì´ë“œë¼ì¸ì´ë‚˜ ë§¥ë½ ì •ë³´
   - **ì €ì¥ì†Œ: mem0**ì— ì €ì¥ë¨

2. **DMN_RULE (ì˜ì‚¬ê²°ì • ê·œì¹™) â†’ DMN Rule ì €ì¥ì†Œ**
   - ì¡°ê±´-ê²°ê³¼ í˜•íƒœì˜ ë¹„ì¦ˆë‹ˆìŠ¤ íŒë‹¨ ê·œì¹™
   - "ë§Œì•½ Xì´ë©´ Yí•´ì•¼ í•œë‹¤", "í•­ìƒ Xí•´ì•¼ í•œë‹¤", "ë°˜ë“œì‹œ Xí•´ì•¼ í•œë‹¤"
   - ëª…í™•í•œ ì¡°ê±´ë¬¸ê³¼ ê·¸ì— ë”°ë¥¸ í–‰ë™ ê·œì¹™
   - ì˜ˆ: "ì£¼ë¬¸ ê¸ˆì•¡ì´ 100ë§Œì› ì´ìƒì´ë©´ ê²°ì œ ìŠ¹ì¸ì„ ë°›ì•„ì•¼ í•œë‹¤"
   - ì˜ˆ: "í•­ìƒ ì‚¬ìš©ìì—ê²Œ í™•ì¸ì„ ë°›ì•„ì•¼ í•œë‹¤"
   - **ì €ì¥ì†Œ: DMN Rule**ì— ì €ì¥ë¨
   
3. **SKILL (ì‹¤í–‰ ê·œì¹™) â†’ Skills ì €ì¥ì†Œ**
   - ë°˜ë³µ ê°€ëŠ¥í•œ ì ˆì°¨, í–‰ë™ ë°©ì‹, ì‘ì—… ìˆœì„œ
   - "ë¨¼ì € Xë¥¼ í•˜ê³ , ê·¸ ë‹¤ìŒ Yë¥¼ í•˜ê³ , ë§ˆì§€ë§‰ìœ¼ë¡œ Zë¥¼ í•œë‹¤"
   - ë‹¨ê³„ë³„ ì²˜ë¦¬ ë°©ë²•ì´ë‚˜ ì‹¤í–‰ ì ˆì°¨
   - ì˜ˆ: "ê³ ê° ë¬¸ì˜ ì‹œ ë¨¼ì € ì´ë©”ì¼ì„ í™•ì¸í•˜ê³ , ê·¸ ë‹¤ìŒ ì „í™”ë¡œ ì—°ë½í•œë‹¤"
   - **ì €ì¥ì†Œ: Skills**ì— ì €ì¥ë¨
   - **SKILL ìƒì„± ì‹œ í•„ìˆ˜ í¬í•¨ ì‚¬í•­:**
     * description: ìŠ¤í‚¬ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (1-2ë¬¸ì¥)
     * overview: ìŠ¤í‚¬ì˜ ëª©ì , ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤, ì „ì²´ì ì¸ íë¦„ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª… (3-5ë¬¸ì¥)
     * steps: ë‹¨ê³„ë³„ ì‹¤í–‰ ì ˆì°¨ (ëª…í™•í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±)
     * usage: ì‚¬ìš©ë²•ì´ ë³µì¡í•˜ê±°ë‚˜ ì£¼ì˜ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° í¬í•¨ (ì„ íƒì )
     * additional_files: ìŠ¤í¬ë¦½íŠ¸ë‚˜ ìœ í‹¸ë¦¬í‹° ì½”ë“œê°€ í•„ìš”í•œ ê²½ìš° scripts/ í´ë”ì— Python íŒŒì¼ ìƒì„± (ì„ íƒì )
   
4. **MIXED (í˜¼í•©)**
   - í•˜ë‚˜ì˜ í”¼ë“œë°±ì— ì—¬ëŸ¬ ìœ í˜•ì´ ì„ì¸ ê²½ìš°
   - ì˜ˆ: "ì£¼ë¬¸ ê¸ˆì•¡ì´ 100ë§Œì› ì´ìƒì´ë©´(ì˜ì‚¬ê²°ì • ê·œì¹™) ë¨¼ì € í™•ì¸í•˜ê³ (ì‹¤í–‰ ê·œì¹™) ì‚¬ìš©ìì—ê²Œ ì•Œë ¤ì•¼ í•œë‹¤(ê¸°ì–µ)"
   - ê° ìœ í˜•ë³„ë¡œ í•´ë‹¹ ì €ì¥ì†Œì— ì €ì¥ë¨

**ìš°ì„ ìˆœìœ„ ê·œì¹™:**
- DMN_RULE (ì˜ì‚¬ê²°ì • ê·œì¹™) > SKILL (ì‹¤í–‰ ê·œì¹™) > MEMORY (ê¸°ì–µ) ìˆœìœ¼ë¡œ ìš°ì„ ìˆœìœ„ê°€ ë†’ë‹¤
- ì¡°ê±´-ê²°ê³¼ í˜•íƒœê°€ ìˆìœ¼ë©´ DMN_RULE (DMN Rule ì €ì¥ì†Œ)ì´ ìš°ì„ 
- ë‹¨ê³„ë³„ ì ˆì°¨ê°€ ëª…í™•í•˜ë©´ SKILL (Skills ì €ì¥ì†Œ)
- ê·¸ ì™¸ëŠ” MEMORY (mem0 ì €ì¥ì†Œ)

**ì‘ë‹µ í˜•ì‹:**
- ì¶”ê°€ ì„¤ëª… ì—†ì´ ì˜¤ì§ ì•„ë˜ JSON êµ¬ì¡°ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”
- ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡(```)ì´ë‚˜ ê¸°íƒ€ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
- JSON ê°ì²´ë§Œ ì¶œë ¥í•˜ì„¸ìš”

{{
  "target": "MEMORY | DMN_RULE | SKILL | MIXED",
  "artifacts": {{
    "memory": "MEMORY íƒ€ì…ì¼ ê²½ìš°ì˜ ë‚´ìš© (mem0 ì €ì¥ì†Œì— ì €ì¥, ì„ íƒì )",
    "dmn": {{"name": "ê·œì¹™ ì´ë¦„", "condition": "ì¡°ê±´", "action": "ê²°ê³¼"}} (DMN_RULEì¼ ê²½ìš°, DMN Rule ì €ì¥ì†Œì— ì €ì¥, ì„ íƒì ),
    "skill": {{
      "name": "ìŠ¤í‚¬ ì´ë¦„ (ì„ íƒì )",
      "description": "ìŠ¤í‚¬ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (frontmatterìš©, í•„ìˆ˜)",
      "overview": "ìŠ¤í‚¬ì˜ ê°œìš” ë° ëª©ì ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª… (ë³¸ë¬¸ì— í‘œì‹œë  ê°œìš” ì„¹ì…˜, í•„ìˆ˜)",
      "usage": "ìŠ¤í‚¬ ì‚¬ìš©ë²• ë° ì£¼ì˜ì‚¬í•­ (ì„ íƒì , í•„ìš”ì‹œì—ë§Œ í¬í•¨)",
      "steps": ["1ë‹¨ê³„ ì„¤ëª…", "2ë‹¨ê³„ ì„¤ëª…", ...],
      "additional_files": {{
        "scripts/íŒŒì¼ëª….py": "Python ì½”ë“œ ë‚´ìš©"
      }} (ì„ íƒì , ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ í¬í•¨. scripts/ í´ë”ì— Python íŒŒì¼ ìƒì„±)
    }} (SKILLì¼ ê²½ìš°, Skills ì €ì¥ì†Œì— ì €ì¥, ì„ íƒì )
  }},
  "reasoning": "ë¶„ë¥˜ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…"
}}
"""

    try:
        response = await llm.ainvoke(prompt)
        cleaned_content = clean_json_response(response.content)
        
        log(f"ğŸ”€ ë¼ìš°íŒ… LLM ì‘ë‹µ: {cleaned_content}")
        
        parsed_result = json.loads(cleaned_content)
        
        target = parsed_result.get("target", "MEMORY")
        reasoning = parsed_result.get("reasoning", "")
        
        log(f"ğŸ“Š í•™ìŠµ ë¼ìš°íŒ… ê²°ê³¼: {target} (ì´ìœ : {reasoning})")
        
        return {
            "target": target,
            "artifacts": parsed_result.get("artifacts", {}),
            "reasoning": reasoning
        }
        
    except json.JSONDecodeError as e:
        log(f"âŒ ë¼ìš°íŒ… JSON íŒŒì‹± ì‹¤íŒ¨ - ì‘ë‹µ: {response.content if 'response' in locals() else 'None'}")
        handle_error("í•™ìŠµë¼ìš°íŒ… JSON íŒŒì‹±", f"ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {e}")
        # ê¸°ë³¸ê°’ìœ¼ë¡œ MEMORY ë°˜í™˜
        return {
            "target": "MEMORY",
            "artifacts": {"memory": content},
            "reasoning": "JSON íŒŒì‹± ì‹¤íŒ¨ë¡œ ê¸°ë³¸ê°’ ì‚¬ìš©"
        }
    except Exception as e:
        handle_error("í•™ìŠµë¼ìš°íŒ…", e)
        # ê¸°ë³¸ê°’ìœ¼ë¡œ MEMORY ë°˜í™˜
        return {
            "target": "MEMORY",
            "artifacts": {"memory": content},
            "reasoning": f"ì—ëŸ¬ ë°œìƒ: {str(e)}"
        }
